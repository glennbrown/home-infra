---
# Debian/Ubuntu Basic Setup
- hosts: debian ubuntu
  remote_user: root
  gather_facts: true
  vars_files:
    - 'vars/vault.yml'
    - 'vars/secrets_lookup.yml'
  tasks:
    - name: Apt Update
      apt:
        upgrade: yes
        update_cache: true
        cache_valid_time: 3600

    - name: Install sudo
      apt:
        name: sudo
        state: present

    - name: Ensure groups exists
      group:
        name: "{{ item.name }}"
        gid: "{{ item.gid | default (omit) }}"
        state: present
      loop: "{{ group_list }}"

    - name: Add Users
      user:
        name: "{{ item.name }}"
        password: "{{ item.password }}"
        groups: "{{ item.groups }}"
        move_home: true
        shell: "{{ item.shell | default ('/bin/bash') }}"
        uid: "{{ item.uid | default (omit) }}"
        update_password: on_create
        append: yes
        state: present
      loop: "{{ user_list }}"

    - name: Add SSH Keys
      authorized_key:
        user: "{{ item.name }}"
        key: "{{ item.key }}"
        state: present
      loop: "{{ authorized_key_list }}"

    - name: Add secured SSH config
      copy:
        src: sshd_config
        dest: /etc/ssh/sshd_config
        owner: root
        group: root
        mode: 0644
      notify: Restart ssh

  handlers:
    - name: Restart ssh
      systemd_service:
        name: sshd
        daemon_reload: true
        enabled: true
        stated: restarted



# Redhat/Fedora Basic Setup
- hosts: redhat
  remote_user: root
  gather_facts: true
  vars_files:
    - 'vars/vault.yml'
    - 'vars/secrets_lookup.yml'
  tasks:
    - name: Yum Update
      yum:
        name: '*'
        update_cache: true
        state: latest

    - name: Install sudo
      yum:
        name: sudo
        state: present

    - name: Ensure groups exists
      group:
        name: "{{ item.name }}"
        gid: "{{ item.gid | default (omit) }}"
        state: present
      loop: "{{ group_list }}"

    - name: Add Users
      user:
        name: "{{ item.name }}"
        password: "{{ item.password }}"
        groups: "{{ item.groups }}"
        move_home: true
        shell: "{{ item.shell | default ('/bin/bash') }}"
        uid: "{{ item.uid | default (omit) }}"
        update_password: on_create
        append: yes
        state: present
      loop: "{{ user_list }}"

    - name: Add SSH Keys
      authorized_key:
        user: "{{ item.name }}"
        key: "{{ item.key }}"
        state: present
      loop: "{{ authorized_key_list }}"
